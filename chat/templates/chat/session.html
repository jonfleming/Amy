<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Fleming AI</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
      crossorigin="anonymous"
    ></script>
    <style>
      body {
        display: flex;
        min-height: 100vh;
        flex-direction: column;
        padding: 10% 10% 10% 10%;
      }

      header {
        background-color: lightgray;
        height: 50px;
        width: 100%;
        position: fixed;
        top: 0;
        left: 0;
        padding: 0% 5% 0% 5%;
        margin: 0% 10% 0% 10%;
      }

      main {
        flex: 1;
        overflow: auto;
        padding: 50px;
        height: 68vh;
      }

      footer {
        background-color: lightgray;
        height: 50px;
        width: 100%;
        position: fixed;
        bottom: 0;
        left: 0;
      }

      #submit {
        margin-top: 5px;
      }
    </style>
    <script>
      let main, mainForm, utterance;

      document.addEventListener('DOMContentLoaded', function(){ 
        main = document.querySelector('main');
        mainForm = document.querySelector('#main-form');
        utterance = document.getElementById("utterance");

          mainForm.addEventListener('submit', event => {
          event.preventDefault();
          myHandler();
        });      
      }, false);

      async function myHandler() {
        postForm()
        .then((response) => response.text())
        .then((data) => {
          appendResponse(data);
          utterance.value = '';

          main.scrollTo(0, main.scrollHeight);
        });

        return false;
      }

      async function postForm() {
        const url = document.location.href;
        // const data = { utterance, csrf_token: '{{ csrf_token }}'};
        const data = Object.fromEntries(new FormData(mainForm));

        const init = {
          method: 'POST',
          mode: 'cors',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json, text/plain, */*',
            'X-CSRFToken': data.csrfmiddlewaretoken
          },
          body: JSON.stringify(data)
        };

        const response = await fetch(url, init);
        return response;
      }

      function appendResponse(data) {
        const conversation = document.getElementById("conversation");
        conversation.innerHTML += data;     
      }
    </script>
  </head>
  <body class="fs-4">
      <form id="main-form" action="{% url 'chat:session' %}" method="post">
        <header>Fleming AI</header>
        <main>
          {% csrf_token %}
          <div id="conversation">
            <p id="messages"></p>
          </div>
        </main>
        </footer>
          <div id="input" class="footer">
            <fieldset><legend>Question</legend>
              <label for="user">{{ user }}: </label>
              <input
                class="form-control"
                id="utterance"
                type="text"
                name="utterance"
                placeholder="Type something and press Enter."
                x-ref="inputx"
              />
            </fieldset>
              <input
                id="submit"
                class="btn btn-primary float-end flex-grow-1"
                type="submit"
                size="sm"
                value="Send"
                onclick="event.preventDefault(); myHandler();"
              />
            </div>
          </div>
        </footer>
      </form>
      </div>
  </body>
</html>
